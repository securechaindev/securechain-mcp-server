from json import dumps

from mcp.types import TextContent

from app.dependencies import get_exploit_service, get_json_encoder
from app.exceptions import ExploitNotFoundException, ExploitsNotFoundException


async def get_exploit_tool(
    exploit_id: str
) -> list[TextContent]:
    exploit_service = get_exploit_service()
    json_encoder = get_json_encoder()
    try:
        out = await exploit_service.read_exploit_by_id(exploit_id)
        return [TextContent(type="text", text=dumps(json_encoder.encode(out), ensure_ascii=False, indent=2))]
    except ExploitNotFoundException:
        return [TextContent(type="text", text=f"Exploit {exploit_id} not found.")]
    except Exception as e:
        return [TextContent(type="text", text=f"Error: {e!s}")]


async def get_exploits_by_vulnerability_tool(
    vulnerability_id: str
) -> list[TextContent]:
    exploit_service = get_exploit_service()
    json_encoder = get_json_encoder()
    try:
        out = await exploit_service.read_exploits_by_vulnerability_id(vulnerability_id)
        return [TextContent(type="text", text=dumps(json_encoder.encode(out), ensure_ascii=False, indent=2))]
    except ExploitsNotFoundException:
        return [TextContent(type="text", text=f"Exploit not found for vulnerability {vulnerability_id}.")]
    except Exception as e:
        return [TextContent(type="text", text=f"Error: {e!s}")]
