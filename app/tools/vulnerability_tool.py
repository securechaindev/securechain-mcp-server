from json import dumps

from mcp.types import TextContent

from app.dependencies import get_json_encoder, get_vulnerability_service
from app.exceptions import (
    VulnerabilitiesNotFoundException,
    VulnerabilityNotFoundException,
)
from app.services import VulnerabilityService
from app.utils import JSONEncoder


class VulnerabilityTool:
    def __init__(self):
        self.vulnerability_service: VulnerabilityService = get_vulnerability_service()
        self.json_encoder: JSONEncoder = get_json_encoder()

    async def get_vulnerability_tool(
        self,
        vulnerability_id: str
    ) -> list[TextContent]:
        try:
            out = await self.vulnerability_service.read_vulnerability_by_id(vulnerability_id)
            return [TextContent(type="text", text=dumps(self.json_encoder.encode(out), ensure_ascii=False, indent=2))]
        except VulnerabilityNotFoundException:
            return [TextContent(type="text", text=f"Vulnerability {vulnerability_id} not found.")]
        except Exception as e:
            return [TextContent(type="text", text=f"Error: {e!s}")]


    async def get_vulnerabilities_by_cwe_tool(
        self,
        cwe_id: str
    ) -> list[TextContent]:
        try:
            out = await self.vulnerability_service.read_vulnerabilities_by_cwe_id(cwe_id)
            return [TextContent(type="text", text=dumps(self.json_encoder.encode(out), ensure_ascii=False, indent=2))]
        except VulnerabilitiesNotFoundException:
            return [TextContent(type="text", text=f"Vulneraribilities not found for {cwe_id}.")]
        except Exception as e:
            return [TextContent(type="text", text=f"Error: {e!s}")]


    async def get_vulnerabilities_by_exploit_tool(
        self,
        exploit_id: str
    ) -> list[TextContent]:
        try:
            out = await self.vulnerability_service.read_vulnerabilities_by_exploit_id(exploit_id)
            return [TextContent(type="text", text=dumps(self.json_encoder.encode(out), ensure_ascii=False, indent=2))]
        except VulnerabilitiesNotFoundException:
            return [TextContent(type="text", text=f"Vulneraribilities not found for {exploit_id}.")]
        except Exception as e:
            return [TextContent(type="text", text=f"Error: {e!s}")]
