from typing import Any

from app.database import DatabaseManager
from app.exceptions import (
    VulnerabilitiesNotFoundException,
    VulnerabilityNotFoundException,
)


class VulnerabilityService:
    def __init__(self, db: DatabaseManager):
        self.vulnerability_collection = db.get_vulnerabilities_collection()
        self._excluded_fields = {"_id": 0, "schema_version": 0, "affected": 0}

    def clean_affected_artefacts(self, result: dict[str, Any]) -> dict[str, Any]:
        if "affected_artefacts" in result:
            for key in result["affected_artefacts"]:
                artefact: dict[str, Any] = result["affected_artefacts"][key]
                artefact.pop("introduced_commit", None)
                artefact.pop("fixed_commit", None)
                artefact.pop("intermediate_commits", None)
        return result

    async def read_vulnerability_by_id(self, vulnerability_id: str) -> dict[str, Any]:
        result = await self.vulnerability_collection.find_one(
            {"id": vulnerability_id},
            self._excluded_fields
        )
        if not result:
            raise VulnerabilityNotFoundException()
        return self.clean_affected_artefacts(result)

    async def read_vulnerabilities_by_cwe_id(self, cwe_id: str) -> list[dict[str, Any]]:
        cursor = self.vulnerability_collection.find(
            {"cwes": {"$in": [cwe_id]}},
            self._excluded_fields
        )
        results = await cursor.to_list(length=None)
        if not results:
            raise VulnerabilitiesNotFoundException()
        return [self.clean_affected_artefacts(r) for r in results]

    async def read_vulnerabilities_by_exploit_id(self, exploit_id: str) -> list[dict[str, Any]]:
        cursor = self.vulnerability_collection.find(
            {"exploits": {"$in": [exploit_id]}},
            self._excluded_fields
        )
        results = await cursor.to_list(length=None)
        if not results:
            raise VulnerabilitiesNotFoundException()
        return [self.clean_affected_artefacts(r) for r in results]
