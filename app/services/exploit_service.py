from typing import Any

from app.database import DatabaseManager
from app.exceptions import ExploitNotFoundException, ExploitsNotFoundException


class ExploitService:
    def __init__(self, db: DatabaseManager):
        self.exploits_collection = db.get_exploits_collection()
        self.excluded_fields = {
            "cvelist": 0,
            "_id": 0,
            "_state": 0,
            "_internal": 0,
            "enchantments": 0,
            "cvss2": 0,
            "cvss4": 0,
            "osvdbidlist": 0,
            "immutableFields": 0,
            "references": 0
        }

    async def read_exploit_by_id(self, exploit_id: str) -> dict[str, Any]:
        result = await self.exploits_collection.find_one(
            {"id": exploit_id},
            self.excluded_fields
        )
        if not result:
            raise ExploitNotFoundException()
        return result

    async def read_exploits_by_vulnerability_id(self, vulnerability_id: str) -> list[dict[str, Any]]:
        cursor = self.exploits_collection.find(
            {"cvelist": {"$in": [vulnerability_id]}},
            self.excluded_fields
        )
        results = await cursor.to_list(length=None)
        if not results:
            raise ExploitsNotFoundException()
        return results
